name: ci/cd
on:
  push:
    tags: ["v*.*.*"]
  workflow_run:
    workflows: [Build and push images]
    types: [completed]

jobs:
  vps-deployment:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && startsWith(github.ref, 'refs/tags/v') }}
    steps:
      - name: Deploy and run docker container
        uses: appleboy/ssh-action@master
        env:
          TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          script: sh deploy-hypestack.sh
